= Deploying Red Hat Single Sign-On
:experimental:
:imagesdir: images

In this lab you'll learn how to deploy Red Hat Single Sign-On and how to set up a Realm and the other components in that Realm such as:

- Clients - The applications/services that request authN/authZ
- Users - Users are referenced per Realm which may affect how you architect your central identity store
- Themes - Deploy a custom theme simply

...as well as how to integrate a few applications with Red Hat Single Sign-On.

=== 1. Deploy Red Hat Single Sign-On

Letâ€™s deploy *Red Hat Single Sign-On (RH-SSO)* that enables service authentication for traffic in the service mesh.

_Red Hat Single Sign-On (RH-SSO)_ is based on the *Keycloak* project and enables you to secure your web applications by providing Web single sign-on (SSO) capabilities based on popular standards such as *SAML 2.0, OpenID Connect and OAuth 2.0*. The RH-SSO server can act as a SAML or OpenID Connect-based Identity Provider, mediating with your enterprise user directory or 3rd-party SSO provider for identity information and your applications via standards-based tokens. The major features include:

* *Authentication Server* - Acts as a standalone SAML or OpenID Connect-based Identity Provider.
* *User Federation* - Certified with LDAP servers and Microsoft Active Directory as sources for user information.
* *Identity Brokering* - Integrates with 3rd-party Identity Providers including leading social networks as identity source.
* *REST APIs and Administration GUI* - Specify user federation, role mapping, and client applications with easy-to-use Administration GUI and REST APIs.

We will deploy RH-SSO in a new project. Go to the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-sso[Topology View^] of the {{ USER_ID }}-sso project:

image::select_project_topology.png[rhsso, 500]

Click on *From Catalog* in Topology view:

image::create_project_fc.png[rhsso, 700]

Type `ccn` in search box and click on *CCN + Red Hat Single Sign-On 7.4 on OpenJDK + PostgreSQL* catalog. Then click on *Instantiate Template*:

image::catalog_rhsso.png[rhsso, 700]

[NOTE]
====
Leave the default template variables - scroll to the bottom and click *Create*
====

Add the following labels in CodeReady Workspaces Terminal:

[source,sh,role="copypaste"]
----
oc project {{ USER_ID}}-sso && \
oc label dc/sso app.openshift.io/runtime=sso && \
oc label dc/sso-postgresql app.openshift.io/runtime=postgresql --overwrite && \
oc label dc/sso-postgresql app.kubernetes.io/part-of=sso --overwrite && \
oc label dc/sso app.kubernetes.io/part-of=sso --overwrite && \
oc annotate dc/sso-postgresql app.openshift.io/connects-to=sso --overwrite
----

Go back to the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-sso[Topology View^]:

image::rhsso-topology.png[sso, 700]

=== 2. Get the Admin Credentials & Log In

Since we instantiated the RH SSO template with the default parameters, a random admin username and password are generated.  We can find the credentials by looking at the `sso` DeploymentConfig.

Run the following labels in {{ ECLIPSE_CHE_URL }}[the CodeReady Workspaces Terminal^]:

[source,sh,role="copypaste"]
----
SSO_ADMIN_USER=$(oc get dc sso -n {{ USER_ID}}-sso -o jsonpath='{.spec.template.spec.containers[0].env}' | jq -r '.[] | select(.name | test("SSO_ADMIN_USERNAME")).value')
SSO_ADMIN_PASS=$(oc get dc sso -n {{ USER_ID}}-sso -o jsonpath='{.spec.template.spec.containers[0].env}' | jq -r '.[] | select(.name | test("SSO_ADMIN_PASSWORD")).value')

echo -e "\nAdmin User: ${SSO_ADMIN_USER}\nAdmin Pass: ${SSO_ADMIN_PASS}\n"
----

[NOTE]
====
Take note of the credentials - you can always reference them with the command/vars
====

Once the deployment finishes (it may take a minute or two), click on https://secure-sso-{{ USER_ID }}-sso.{{ ROUTE_SUBDOMAIN}}[Secure SSO Route^] to access RH-SSO web console as below:

image::rhsso_landing_page.png[sso, 700]

Click on _Administration Console_ to log in and configure the Realm:

image::rhsso_admin_login.png[sso, 700]

=== 3. Create a Realm

First we must create a *Realm*.

A Realm manages a set of users, credentials, roles, and groups. A user belongs to and logs into a realm. Realms are isolated from one another and can only manage and authenticate the users that they control.

In the upper left corner of the RH SSO Administration Console, hover over *Master* until the Realm Dropdown appears - *click Add realm*

image::rhsso_add-realm-button.png[sso, 420]

Give the Realm the name of `petcorp` - then click *Create*

image::rhsso_add-realm.png[sso, 1020]

Set the following additional configuration for the Realm in the General Tab:

  - *General tab, Display Name:* `Pet Corp`
  - *General tab, HTML Display Name:* `<div class="kc-logo-text"><span>MyPurrina</span></div>`
  - *General tab*: CLICK SAVE

image::rhsso_realm_general_config.png[sso, 1100]

  - *Login tab, Login With Email*: OFF
  - *Login tab, Require SSL*: None
  - *Login tab*: CLICK SAVE

image::rhsso_realm_login_config.png[sso, 1100]

  - *Themes tab:* Set All to `rh-sso`
  - *Themes tab:* CLICK SAVE

image::rhsso_realm_themes_config.png[sso, 1100]

=== 4. Create Application Clients

*Clients* are entities that can request Keycloak to authenticate a user. Most often, clients are applications and services that want to use Keycloak to secure themselves and provide a single sign-on solution. Clients can also be entities that just want to request identity information or an access token so that they can securely invoke other services on the network that are secured by Keycloak.

We will add two Clients to this Petcorp Realm.

==== PetID Client

In the left-hand pane, navigate to *Clients* and then click *Create* to the right

image::rhsso_create_client_button.png[sso, 1100]

Give it a Client ID of `pet-id` - click *Save*

image::rhsso_create_client_pet-id.png[sso, 1100]

Configure the Client Settings with the following:

- *Login Theme*: `rh-sso`
- *Valid Redirect URIs*: `*`
- *Web Origins*: `*`

image::rhsso_client_config_pet-id.png[sso, 1100]

==== Furever Home Client

In the left-hand pane, navigate to *Clients* and then click *Create* to the right

image::rhsso_create_client_button.png[sso, 1100]

Give it a Client ID of `furever-home` - click *Save*

image::rhsso_create_client_furever-home.png[sso, 1100]

Configure the Client Settings with the following:

- *Login Theme*: `rh-sso`
- *Valid Redirect URIs*: `*`
- *Web Origins*: `*`

image::rhsso_client_config_furever-home.png[sso, 1100]

=== 5. Create Users

We are logged into the RH SSO Administrative Console but this user is not part of this Realm - in fact, this Realm has no users so before we can use our secured applications we need a user or two.

In the left-hand pane, navigate to *Clients* and then click *Create* to the right

image::rhsso_add_user_button.png[sso, 1100]

For this exercise we'll create two users - `luser` and `sadmin`

Create a user with the following information:

- *Username*: `luser`
- *Email*: `luser@example.com`
- *First Name*: `Luser`
- *Last Name*: `Smith`
- *User Enabled*: On
- *Email Verified*: On
- *Click Save*

image::rhsso_add_user_luser.png[sso, 1100]

With the user created, click the *Credentials* tab and set the password for the user to - set it to something like `password`.

Make sure to set *Temporary* to Off!

image::rhsso_set_user_password_luser.png[sso, 1100]

Create another user with the following information:

- *Username*: `sadmin`
- *Email*: `sadmin@example.com`
- *First Name*: `Sadmin`
- *Last Name*: `Jones`
- *User Enabled*: On
- *Email Verified*: On
- *Click Save*

image::rhsso_add_user_sadmin.png[sso, 1100]

With the user created, click the *Credentials* tab and set the password for the user to - set it to something like `password`.

Make sure to set *Temporary* to Off!

image::rhsso_set_user_password_sadmin.png[sso, 1100]
