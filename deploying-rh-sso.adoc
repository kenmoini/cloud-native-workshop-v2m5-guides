= Deploying Red Hat Single Sign-On
:experimental:
:imagesdir: images

In this lab you'll learn how to deploy Red Hat Single Sign-On and how to set up a Realm and the other components in that Realm such as:

- Clients - The applications/services that request authN/authZ
- Users - Users are referenced per Realm which may affect how you architect your central identity store
- Themes - Deploy a custom theme simply

...as well as how to integrate a few applications with Red Hat Single Sign-On.

=== 1. Deploy Red Hat Single Sign-On

Letâ€™s deploy *Red Hat Single Sign-On (RH-SSO)* that enables service authentication for traffic in the service mesh.

_Red Hat Single Sign-On (RH-SSO)_ is based on the *Keycloak* project and enables you to secure your web applications by providing Web single sign-on (SSO) capabilities based on popular standards such as *SAML 2.0, OpenID Connect and OAuth 2.0*. The RH-SSO server can act as a SAML or OpenID Connect-based Identity Provider, mediating with your enterprise user directory or 3rd-party SSO provider for identity information and your applications via standards-based tokens. The major features include:

* *Authentication Server* - Acts as a standalone SAML or OpenID Connect-based Identity Provider.
* *User Federation* - Certified with LDAP servers and Microsoft Active Directory as sources for user information.
* *Identity Brokering* - Integrates with 3rd-party Identity Providers including leading social networks as identity source.
* *REST APIs and Administration GUI* - Specify user federation, role mapping, and client applications with easy-to-use Administration GUI and REST APIs.

We will deploy RH-SSO in a new project. Go to the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-sso[Topology View^] of the {{ USER_ID }}-sso project:

image::select_project_topology.png[rhsso, 500]

Click on *From Catalog* in Topology view:

image::create_project_fc.png[rhsso, 700]

Type `ccn` in search box and click on *CCN + Red Hat Single Sign-On 7.4 on OpenJDK + PostgreSQL* catalog. Then click on *Instantiate Template*:

image::catalog_rhsso.png[rhsso, 700]

[NOTE]
====
Leave the default template variables - scroll to the bottom and click *Create*
====

Add the following labels in CodeReady Workspaces Terminal:

[source,sh,role="copypaste"]
----
oc project {{ USER_ID}}-sso && \
oc label dc/sso app.openshift.io/runtime=sso && \
oc label dc/sso-postgresql app.openshift.io/runtime=postgresql --overwrite && \
oc label dc/sso-postgresql app.kubernetes.io/part-of=sso --overwrite && \
oc label dc/sso app.kubernetes.io/part-of=sso --overwrite && \
oc annotate dc/sso-postgresql app.openshift.io/connects-to=sso --overwrite
----

Go back to the {{ CONSOLE_URL }}/topology/ns/{{ USER_ID }}-sso[Topology View^]:

image::rhsso-topology.png[sso, 700]

=== 2. Get the Admin Credentials & Log In

Since we instantiated the RH SSO template with the default parameters, a random admin username and password are generated.  We can find the credentials by looking at the `sso` DeploymentConfig.

Run the following labels in CodeReady Workspaces Terminal:

[source,sh,role="copypaste"]
----
SSO_ADMIN_USER=$(oc get dc sso -n {{ USER_ID}}-sso -o jsonpath='{.spec.template.spec.containers[0].env}' | jq -r '.[] | select(.name | test("SSO_ADMIN_USERNAME")).value')
SSO_ADMIN_PASS=$(oc get dc sso -n {{ USER_ID}}-sso -o jsonpath='{.spec.template.spec.containers[0].env}' | jq -r '.[] | select(.name | test("SSO_ADMIN_PASSWORD")).value')

echo "Admin User: ${SSO_ADMIN_USER}"
echo "Admin Pass: ${SSO_ADMIN_PASS}"
----

[NOTE]
====
Take note of the credentials - you can always reference them with the command/vars
====

Once the deployment finishes (it may take a minute or two), click on https://secure-sso-{{ USER_ID }}-sso.{{ ROUTE_SUBDOMAIN}}[Secure SSO Route^] to access RH-SSO web console as below:

image::rhsso_landing_page.png[sso, 700]

Click on _Administration Console_ to log in and configure the Realm:

image::rhsso_admin_login.png[sso, 700]

=== 3. Create a Realm

First we must create a *Realm*.

A Realm manages a set of users, credentials, roles, and groups. A user belongs to and logs into a realm. Realms are isolated from one another and can only manage and authenticate the users that they control.

- Create Petcorp Realm
- Configure Realm:
  - General, Display Name: `Pet Corp`
  - General, HTML Display Name: `<div class="kc-logo-text"><span>MyPurrina</span></div>`
  - General - CLICK SAVE
  - Login, Login With Email: OFF
  - Login, Require SSL: False
  - Login - CLICK SAVE
  - Themes, Set All to RH SSO
  - Themes - CLICK SAVE
- Add Clients:
  - PetID Front End
    - Name: pet-id
    - Client Protocol: OpenID Connect
    - Click CREATE
    
    - Set Login Theme to rh-sso
    - Valid Redirect URIs: *
    - Web Origins: *
  - Furever Home Front End
    - Name: furever-home
    - Client Protocol: OpenID Connect
    - Click CREATE

    - Set Login Theme to rh-sso
    - Valid Redirect URIs: *
- Create Users - The userNN is the admin, there needs to be Realm users
  - Create user, give username, email @example.com, First/Last, both verified
  - Credentials tab, Set password, toggle to not Temporary
